<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penny Admin - Waitlist Dashboard</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="../32x32.png">
    <link rel="shortcut icon" href="../32x32.png">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        penny: {
                            50: '#ecfeff',
                            100: '#cffafe',
                            200: '#a5f3fc',
                            300: '#67e8f9',
                            400: '#22d3ee',
                            500: '#14d4cc',
                            600: '#0891b2',
                            700: '#0e7490',
                        }
                    },
                    fontFamily: {
                        'poppins': ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast-enter {
            animation: slideIn 0.3s ease-out forwards;
        }

        .toast-exit {
            animation: slideOut 0.3s ease-in forwards;
        }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-[100] space-y-3 pointer-events-none">
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
        <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <div class="inline-flex items-center gap-3 mb-4">
                    <img src="../images/newicon.png" alt="Penny Icon" class="h-12">
                    <h1 class="text-2xl font-bold text-slate-900">Penny Admin</h1>
                </div>
                <p class="text-slate-600">Sign in to access dashboard</p>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                    <input
                        type="email"
                        id="emailInput"
                        placeholder="admin@penny.app"
                        required
                        class="w-full px-4 py-3 rounded-lg border-2 border-slate-200 focus:border-penny-500 focus:outline-none text-slate-800"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                    <input
                        type="password"
                        id="passwordInput"
                        placeholder="Enter your password"
                        required
                        class="w-full px-4 py-3 rounded-lg border-2 border-slate-200 focus:border-penny-500 focus:outline-none text-slate-800"
                    />
                </div>
                <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                <button
                    type="submit"
                    id="loginBtn"
                    class="w-full bg-gradient-to-r from-penny-500 to-penny-600 text-white font-semibold px-6 py-3 rounded-lg shadow-lg hover:shadow-xl transition-all"
                >
                    Sign In
                </button>
            </form>

            <div class="mt-4 text-center">
                <button id="forgotPasswordBtn" class="text-sm text-penny-600 hover:text-penny-700">
                    Forgot password?
                </button>
            </div>

            <div class="mt-6 pt-6 border-t border-slate-200">
                <p class="text-xs text-slate-500 text-center">
                    Secured with Firebase Authentication<br/>
                    Need access? Contact your administrator
                </p>
            </div>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="resetPasswordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center px-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900">Reset Password</h2>
                <button id="closeResetBtn" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="resetPasswordForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Email Address</label>
                    <input
                        type="email"
                        id="resetEmailInput"
                        placeholder="Enter your email"
                        required
                        class="w-full px-4 py-3 rounded-lg border-2 border-slate-200 focus:border-penny-500 focus:outline-none text-slate-800"
                    />
                </div>

                <div id="resetError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                <div id="resetSuccess" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-sm"></div>

                <button
                    type="submit"
                    class="w-full bg-gradient-to-r from-penny-500 to-penny-600 text-white font-semibold px-6 py-3 rounded-lg shadow-lg hover:shadow-xl transition-all"
                >
                    Send Reset Link
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="../images/newicon.png" alt="Penny Icon" class="h-10">
                    <div>
                        <h1 class="text-xl font-bold text-slate-900">Penny Admin</h1>
                        <p class="text-sm text-slate-500">Waitlist Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-slate-600" id="adminEmail"></span>
                    <button
                        id="refreshBtn"
                        class="p-2 text-slate-600 hover:text-teal-600 hover:bg-teal-50 rounded-lg transition-colors"
                        title="Refresh Data"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                    <button
                        id="settingsBtn"
                        class="p-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors"
                        title="Settings"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                    <button
                        id="logoutBtn"
                        class="px-4 py-2 text-slate-600 hover:text-slate-900 font-medium transition-colors"
                    >
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8">

            <!-- Stats Cards -->
            <div class="grid md:grid-cols-4 gap-6 mb-8">
                <!-- Total Visitors -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-slate-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-slate-600">Total Visitors</h3>
                        <span class="text-2xl">üë•</span>
                    </div>
                    <p class="text-4xl font-bold text-slate-900" id="totalVisitors">0</p>
                    <p class="text-sm text-slate-500 mt-2">Page views tracked</p>
                </div>

                <!-- Waitlist Signups -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-penny-200 bg-gradient-to-br from-white to-penny-50">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-slate-600">Waitlist Signups</h3>
                        <span class="text-2xl">‚úâÔ∏è</span>
                    </div>
                    <p class="text-4xl font-bold text-penny-600" id="totalEmails">0</p>
                    <p class="text-sm text-slate-500 mt-2">Email subscribers</p>
                </div>

                <!-- Contact Messages -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-slate-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-slate-600">Contact Messages</h3>
                        <span class="text-2xl">üí¨</span>
                    </div>
                    <p class="text-4xl font-bold text-slate-900" id="totalMessages">0</p>
                    <p class="text-sm text-slate-500 mt-2">Support inquiries</p>
                </div>

                <!-- Conversion Rate -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-slate-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-slate-600">Conversion Rate</h3>
                        <span class="text-2xl">üìà</span>
                    </div>
                    <p class="text-4xl font-bold text-slate-900" id="conversionRate">0%</p>
                    <p class="text-sm text-slate-500 mt-2">Visitors to signups</p>
                </div>
            </div>

            <!-- Suggestions Table -->
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-penny-200 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-900">User Suggestions</h2>
                    <button
                        id="exportSuggestionsBtn"
                        class="px-4 py-2 bg-penny-500 text-white font-medium rounded-lg hover:bg-penny-600 transition-colors"
                    >
                        Export CSV
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-slate-200">
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">#</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Suggestion</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Email</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Date</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Time</th>
                            </tr>
                        </thead>
                        <tbody id="suggestionsTableBody">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-slate-500">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Blog Management Section -->
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-slate-200 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-900">Blog Posts</h2>
                    <button
                        id="createBlogBtn"
                        class="px-4 py-2 bg-gradient-to-r from-penny-500 to-penny-600 text-white font-semibold rounded-lg hover:shadow-lg transition-all"
                    >
                        + New Blog Post
                    </button>
                </div>

                <!-- Blog Posts List -->
                <div id="blogPostsList" class="space-y-4">
                    <div class="text-center py-8 text-slate-500">Loading blog posts...</div>
                </div>
            </div>

            <!-- Blog Editor Modal -->
            <div id="blogEditorModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-slate-900" id="blogEditorTitle">Create New Blog Post</h3>
                        <button id="closeBlogEditor" class="text-slate-400 hover:text-slate-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <form id="blogPostForm" class="p-6 space-y-6">
                        <input type="hidden" id="blogPostId" value="">

                        <!-- Title -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Title</label>
                            <input
                                type="text"
                                id="blogTitle"
                                required
                                placeholder="Enter blog post title"
                                class="w-full px-4 py-3 rounded-lg border-2 border-slate-200 focus:border-penny-500 focus:outline-none text-slate-800 font-medium"
                            />
                        </div>

                        <!-- Slug -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Slug (URL-friendly)</label>
                            <input
                                type="text"
                                id="blogSlug"
                                required
                                placeholder="blog-post-url-slug"
                                class="w-full px-4 py-3 rounded-lg border-2 border-slate-200 focus:border-penny-500 focus:outline-none text-slate-800"
                            />
                            <p class="text-xs text-slate-500 mt-1">This will be used in the URL: penny.app/blog/your-slug</p>
                        </div>

                        <!-- Author -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Author</label>
                            <input
                                type="text"
                                id="blogAuthor"
                                required
                                placeholder="John Doe"
                                class="w-full px-4 py-3 rounded-lg border-2 border-slate-200 focus:border-penny-500 focus:outline-none text-slate-800"
                            />
                        </div>

                        <!-- Excerpt -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Excerpt (Short Description)</label>
                            <textarea
                                id="blogExcerpt"
                                required
                                rows="2"
                                placeholder="A brief summary of the blog post..."
                                class="w-full px-4 py-3 rounded-lg border-2 border-slate-200 focus:border-penny-500 focus:outline-none text-slate-800 resize-none"
                            ></textarea>
                        </div>

                        <!-- Content -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Content (Markdown supported)</label>
                            <textarea
                                id="blogContent"
                                required
                                rows="12"
                                placeholder="Write your blog post content here... Markdown is supported!"
                                class="w-full px-4 py-3 rounded-lg border-2 border-slate-200 focus:border-penny-500 focus:outline-none text-slate-800 font-mono text-sm resize-none"
                            ></textarea>
                        </div>

                        <!-- Category & Tags -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Category</label>
                                <select
                                    id="blogCategory"
                                    required
                                    class="w-full px-4 py-3 rounded-lg border-2 border-slate-200 focus:border-penny-500 focus:outline-none text-slate-800"
                                >
                                    <option value="">Select category</option>
                                    <option value="finance">Finance Tips</option>
                                    <option value="savings">Savings</option>
                                    <option value="budgeting">Budgeting</option>
                                    <option value="investing">Investing</option>
                                    <option value="news">Company News</option>
                                    <option value="tutorials">Tutorials</option>
                                    <option value="story">Story</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Tags (comma-separated)</label>
                                <input
                                    type="text"
                                    id="blogTags"
                                    placeholder="money, tips, budget"
                                    class="w-full px-4 py-3 rounded-lg border-2 border-slate-200 focus:border-penny-500 focus:outline-none text-slate-800"
                                />
                            </div>
                        </div>

                        <!-- Featured Image URL -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Featured Image URL (optional)</label>
                            <input
                                type="url"
                                id="blogImageUrl"
                                placeholder="https://example.com/image.jpg"
                                class="w-full px-4 py-3 rounded-lg border-2 border-slate-200 focus:border-penny-500 focus:outline-none text-slate-800"
                            />
                        </div>

                        <!-- Published Status -->
                        <div class="flex items-center gap-3">
                            <input
                                type="checkbox"
                                id="blogPublished"
                                class="w-5 h-5 rounded border-slate-300 text-penny-500 focus:ring-penny-500"
                            />
                            <label for="blogPublished" class="text-sm font-semibold text-slate-700">
                                Publish immediately (uncheck to save as draft)
                            </label>
                        </div>

                        <!-- Form Actions -->
                        <div class="flex gap-3 pt-4 border-t border-slate-200">
                            <button
                                type="submit"
                                class="flex-1 bg-gradient-to-r from-penny-500 to-penny-600 text-white font-semibold px-6 py-3 rounded-lg hover:shadow-lg transition-all"
                            >
                                Save Blog Post
                            </button>
                            <button
                                type="button"
                                id="cancelBlogEdit"
                                class="px-6 py-3 bg-slate-100 text-slate-700 font-medium rounded-lg hover:bg-slate-200 transition-colors"
                            >
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Waitlist Table -->
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-slate-200 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-900">Waitlist Emails</h2>
                    <button
                        id="exportBtn"
                        class="px-4 py-2 bg-penny-500 text-white font-medium rounded-lg hover:bg-penny-600 transition-colors"
                    >
                        Export CSV
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-slate-200">
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">#</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Email</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Signup Date</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Time</th>
                            </tr>
                        </thead>
                        <tbody id="emailTableBody">
                            <tr>
                                <td colspan="4" class="text-center py-8 text-slate-500">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Contact Messages Table -->
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-slate-200 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-900">Contact Messages</h2>
                    <button
                        id="exportMessagesBtn"
                        class="px-4 py-2 bg-penny-500 text-white font-medium rounded-lg hover:bg-penny-600 transition-colors"
                    >
                        Export CSV
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-slate-200">
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">#</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Name</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Email</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Subject</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Message</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Date</th>
                            </tr>
                        </thead>
                        <tbody id="messagesTableBody">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-slate-500">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Visitor Log -->
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-slate-200">
                <h2 class="text-2xl font-bold text-slate-900 mb-6">Recent Visitors</h2>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-slate-200">
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">#</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Date</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Time</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Location</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">IP Address</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-700">Referrer</th>
                            </tr>
                        </thead>
                        <tbody id="visitorTableBody">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-slate-500">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center px-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900">Account Settings</h2>
                <button id="closeSettingsBtn" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="space-y-4">
                <div class="bg-slate-50 rounded-lg p-4">
                    <p class="text-sm font-medium text-slate-700 mb-1">Signed in as:</p>
                    <p class="text-lg font-semibold text-slate-900" id="settingsEmail"></p>
                </div>

                <button
                    id="changePasswordBtn"
                    class="w-full px-4 py-3 bg-slate-100 hover:bg-slate-200 text-slate-900 font-medium rounded-lg transition-colors"
                >
                    Change Password
                </button>

                <button
                    id="enableMFABtn"
                    class="w-full px-4 py-3 bg-penny-100 hover:bg-penny-200 text-penny-900 font-medium rounded-lg transition-colors"
                >
                    üîê Enable Multi-Factor Authentication
                </button>

                <div class="pt-4 border-t border-slate-200">
                    <p class="text-xs text-slate-500 text-center">
                        Protected with Firebase Authentication
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- JavaScript -->
    <script>
        // ========================================
        // TOAST NOTIFICATION SYSTEM
        // ========================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');

            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = 'toast-enter pointer-events-auto';

            const bgColors = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'warning': 'bg-amber-500',
                'info': 'bg-blue-500'
            };

            const icons = {
                'success': '‚úì',
                'error': '‚úï',
                'warning': '‚ö†',
                'info': '‚Ñπ'
            };

            toast.innerHTML = `
                <div class="${bgColors[type] || bgColors.info} text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 min-w-[320px] max-w-md">
                    <span class="text-2xl">${icons[type] || icons.info}</span>
                    <span class="flex-1 font-medium">${message}</span>
                    <button onclick="closeToast('${toastId}')" class="text-white/80 hover:text-white transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;

            container.appendChild(toast);

            setTimeout(() => closeToast(toastId), 5000);
        }

        function closeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }
        }

        // ========================================
        // FIREBASE CONFIGURATION (Same project, separate collections)
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCVkypVjUxN4HdeRmGotHM36Vp8fycPzNY",
            authDomain: "expenses-64949.firebaseapp.com",
            projectId: "expenses-64949",
            storageBucket: "expenses-64949.firebasestorage.app",
            messagingSenderId: "896051349073",
            appId: "1:896051349073:web:89c2f05a87a71708125a70",
            measurementId: "G-2MM74MFJQX"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ========================================
        // AUTHENTICATION STATE
        // ========================================
        auth.onAuthStateChanged((user) => {
            if (user) {
                showDashboard(user);
            } else {
                showLoginScreen();
            }
        });

        function showDashboard(user) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            document.getElementById('adminEmail').textContent = user.email;
            document.getElementById('settingsEmail').textContent = user.email;
            loadDashboardData();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }

        // ========================================
        // LOGIN
        // ========================================
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');

            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            errorDiv.classList.add('hidden');

            try {
                await auth.signInWithEmailAndPassword(email, password);
                // Dashboard will show automatically via onAuthStateChanged
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = getErrorMessage(error.code);
                errorDiv.classList.remove('hidden');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        });

        // ========================================
        // PASSWORD RESET
        // ========================================
        document.getElementById('forgotPasswordBtn').addEventListener('click', function() {
            document.getElementById('resetPasswordModal').classList.remove('hidden');
            const email = document.getElementById('emailInput').value;
            if (email) {
                document.getElementById('resetEmailInput').value = email;
            }
        });

        document.getElementById('closeResetBtn').addEventListener('click', function() {
            document.getElementById('resetPasswordModal').classList.add('hidden');
            document.getElementById('resetPasswordForm').reset();
            document.getElementById('resetError').classList.add('hidden');
            document.getElementById('resetSuccess').classList.add('hidden');
        });

        document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const email = document.getElementById('resetEmailInput').value;
            const errorDiv = document.getElementById('resetError');
            const successDiv = document.getElementById('resetSuccess');

            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            try {
                await auth.sendPasswordResetEmail(email);
                successDiv.textContent = 'Password reset link sent! Check your email.';
                successDiv.classList.remove('hidden');

                setTimeout(() => {
                    document.getElementById('closeResetBtn').click();
                }, 3000);
            } catch (error) {
                console.error('Password reset error:', error);
                errorDiv.textContent = getErrorMessage(error.code);
                errorDiv.classList.remove('hidden');
            }
        });

        // ========================================
        // REFRESH DATA
        // ========================================
        document.getElementById('refreshBtn').addEventListener('click', async function() {
            const button = this;
            const svg = button.querySelector('svg');

            // Add spinning animation
            svg.style.animation = 'spin 1s linear infinite';
            button.disabled = true;
            button.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                // Reload all dashboard data
                await loadDashboardData();

                // Show success feedback
                button.classList.remove('text-slate-600');
                button.classList.add('text-teal-600');
                setTimeout(() => {
                    button.classList.remove('text-teal-600');
                    button.classList.add('text-slate-600');
                }, 1000);
            } catch (error) {
                console.error('Error refreshing data:', error);
                showToast('Error refreshing data. Please try again.', 'error');
            } finally {
                // Remove spinning animation
                svg.style.animation = '';
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        // Add CSS animation for spinning
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // ========================================
        // LOGOUT
        // ========================================
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Error logging out. Please try again.', 'error');
            }
        });

        // ========================================
        // SETTINGS MODAL
        // ========================================
        document.getElementById('settingsBtn').addEventListener('click', function() {
            document.getElementById('settingsModal').classList.remove('hidden');
        });

        document.getElementById('closeSettingsBtn').addEventListener('click', function() {
            document.getElementById('settingsModal').classList.add('hidden');
        });

        document.getElementById('changePasswordBtn').addEventListener('click', async function() {
            const user = auth.currentUser;
            if (user && user.email) {
                try {
                    await auth.sendPasswordResetEmail(user.email);
                    showToast('Password reset link sent to ' + user.email, 'success');
                } catch (error) {
                    console.error('Error sending password reset:', error);
                    showToast('Error sending password reset email. Please try again.', 'error');
                }
            }
        });

        document.getElementById('enableMFABtn').addEventListener('click', function() {
            showToast('MFA setup requires Firebase Console configuration. Check documentation for details.', 'info');
        });

        // ========================================
        // DASHBOARD DATA
        // ========================================
        async function loadDashboardData() {
            try {
                // Load visitors (separate landing page collection)
                const visitorsSnapshot = await db.collection('landing_visitors').get();
                const visitorCount = visitorsSnapshot.size;
                document.getElementById('totalVisitors').textContent = visitorCount;

                // Load waitlist (separate landing page collection)
                const waitlistSnapshot = await db.collection('landing_waitlist').orderBy('timestamp', 'desc').get();
                const emails = [];
                waitlistSnapshot.forEach((doc) => {
                    emails.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                document.getElementById('totalEmails').textContent = emails.length;

                // Load suggestions
                const suggestionsSnapshot = await db.collection('landing_suggestions').orderBy('timestamp', 'desc').get();
                const suggestions = [];
                suggestionsSnapshot.forEach((doc) => {
                    suggestions.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Load contact messages
                const messagesSnapshot = await db.collection('landing_contact_messages').orderBy('timestamp', 'desc').get();
                const messages = [];
                messagesSnapshot.forEach((doc) => {
                    messages.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                document.getElementById('totalMessages').textContent = messages.length;

                // Calculate conversion rate
                const conversionRate = visitorCount > 0 ? ((emails.length / visitorCount) * 100).toFixed(1) : 0;
                document.getElementById('conversionRate').textContent = conversionRate + '%';

                // Populate tables
                populateSuggestionsTable(suggestions);
                populateEmailTable(emails);
                populateMessagesTable(messages);
                populateVisitorTable(visitorsSnapshot);

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Fallback to localStorage if Firestore fails
                const emails = JSON.parse(localStorage.getItem('penny_waitlist') || '[]');
                const suggestions = JSON.parse(localStorage.getItem('penny_suggestions') || '[]');
                const visitorCount = parseInt(localStorage.getItem('penny_visitor_count') || '0');

                document.getElementById('totalVisitors').textContent = visitorCount;
                document.getElementById('totalEmails').textContent = emails.length;

                const conversionRate = visitorCount > 0 ? ((emails.length / visitorCount) * 100).toFixed(1) : 0;
                document.getElementById('conversionRate').textContent = conversionRate + '%';

                populateSuggestionsTable(suggestions);
                populateEmailTable(emails);
            }
        }

        function populateSuggestionsTable(suggestions) {
            const tbody = document.getElementById('suggestionsTableBody');

            if (suggestions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-slate-500">No suggestions yet</td></tr>';
                return;
            }

            tbody.innerHTML = suggestions.map((entry, index) => {
                const timestamp = entry.timestamp;
                let date;

                if (timestamp && timestamp.toDate) {
                    date = timestamp.toDate();
                } else if (typeof timestamp === 'string') {
                    date = new Date(timestamp);
                } else {
                    date = new Date();
                }

                return `
                    <tr class="border-b border-slate-100 hover:bg-slate-50">
                        <td class="py-3 px-4 text-sm text-slate-600">${index + 1}</td>
                        <td class="py-3 px-4 text-sm text-slate-900 max-w-md">
                            <div class="line-clamp-2">${escapeHtml(entry.suggestion)}</div>
                        </td>
                        <td class="py-3 px-4 text-sm font-medium text-slate-700">${escapeHtml(entry.email || 'Anonymous')}</td>
                        <td class="py-3 px-4 text-sm text-slate-600">${date.toLocaleDateString()}</td>
                        <td class="py-3 px-4 text-sm text-slate-600">${date.toLocaleTimeString()}</td>
                    </tr>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function populateMessagesTable(messages) {
            const tbody = document.getElementById('messagesTableBody');

            if (messages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">No contact messages yet</td></tr>';
                return;
            }

            tbody.innerHTML = messages.map((entry, index) => {
                const timestamp = entry.timestamp;
                let date;

                if (timestamp && timestamp.toDate) {
                    date = timestamp.toDate();
                } else if (typeof timestamp === 'string') {
                    date = new Date(timestamp);
                } else {
                    date = new Date();
                }

                return `
                    <tr class="border-b border-slate-100 hover:bg-slate-50">
                        <td class="py-3 px-4 text-sm text-slate-600">${index + 1}</td>
                        <td class="py-3 px-4 text-sm font-medium text-slate-900">${escapeHtml(entry.name || 'N/A')}</td>
                        <td class="py-3 px-4 text-sm text-slate-700">${escapeHtml(entry.email || 'N/A')}</td>
                        <td class="py-3 px-4 text-sm text-slate-700">${escapeHtml(entry.subject || 'N/A')}</td>
                        <td class="py-3 px-4 text-sm text-slate-600 max-w-xs">
                            <div class="line-clamp-2">${escapeHtml(entry.message || 'N/A')}</div>
                        </td>
                        <td class="py-3 px-4 text-sm text-slate-600 whitespace-nowrap">${date.toLocaleDateString()}</td>
                    </tr>
                `;
            }).join('');
        }

        function populateEmailTable(emails) {
            const tbody = document.getElementById('emailTableBody');

            if (emails.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-slate-500">No signups yet</td></tr>';
                return;
            }

            tbody.innerHTML = emails.map((entry, index) => {
                const timestamp = entry.timestamp;
                let date;

                if (timestamp && timestamp.toDate) {
                    date = timestamp.toDate();
                } else if (typeof timestamp === 'string') {
                    date = new Date(timestamp);
                } else {
                    date = new Date();
                }

                return `
                    <tr class="border-b border-slate-100 hover:bg-slate-50">
                        <td class="py-3 px-4 text-sm text-slate-600">${index + 1}</td>
                        <td class="py-3 px-4 text-sm font-medium text-slate-900">${entry.email}</td>
                        <td class="py-3 px-4 text-sm text-slate-600">${date.toLocaleDateString()}</td>
                        <td class="py-3 px-4 text-sm text-slate-600">${date.toLocaleTimeString()}</td>
                    </tr>
                `;
            }).join('');
        }

        let allVisitors = [];
        let visibleVisitorCount = 10;

        function populateVisitorTable(visitorsSnapshot) {
            const tbody = document.getElementById('visitorTableBody');
            allVisitors = [];

            visitorsSnapshot.forEach((doc) => {
                const data = doc.data();
                allVisitors.push(data);
            });

            if (allVisitors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">No visitors yet</td></tr>';
                return;
            }

            // Sort by timestamp (most recent first)
            allVisitors.sort((a, b) => {
                const timeA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate().getTime() : 0;
                const timeB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate().getTime() : 0;
                return timeB - timeA; // Descending order (newest first)
            });

            // Reset visible count when data refreshes
            visibleVisitorCount = 10;
            renderVisitorRows();
        }

        function renderVisitorRows() {
            const tbody = document.getElementById('visitorTableBody');
            const visibleVisitors = allVisitors.slice(0, visibleVisitorCount);

            tbody.innerHTML = visibleVisitors.map((visit, index) => {
                const timestamp = visit.timestamp;
                let date;

                if (timestamp && timestamp.toDate) {
                    date = timestamp.toDate();
                } else {
                    date = new Date();
                }

                // Extract geolocation data
                const geo = visit.geolocation || {};
                const location = geo.city && geo.country
                    ? `${geo.flag || ''} ${geo.city}, ${geo.country}`.trim()
                    : (geo.country ? `${geo.flag || ''} ${geo.country}`.trim() : 'Unknown');
                const ip = geo.ip || 'N/A';

                return `
                    <tr class="border-b border-slate-100 hover:bg-slate-50">
                        <td class="py-3 px-4 text-sm text-slate-600">${index + 1}</td>
                        <td class="py-3 px-4 text-sm text-slate-600">${date.toLocaleDateString()}</td>
                        <td class="py-3 px-4 text-sm text-slate-600">${date.toLocaleTimeString()}</td>
                        <td class="py-3 px-4 text-sm text-slate-700 font-medium">${location}</td>
                        <td class="py-3 px-4 text-sm text-slate-600 font-mono">${ip}</td>
                        <td class="py-3 px-4 text-sm text-slate-600">${visit.referrer || 'Direct'}</td>
                    </tr>
                `;
            }).join('');

            // Add "Load More" button if there are more visitors
            if (visibleVisitorCount < allVisitors.length) {
                const remainingCount = allVisitors.length - visibleVisitorCount;
                tbody.innerHTML += `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <button
                                onclick="loadMoreVisitors()"
                                class="px-6 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors font-medium text-sm"
                            >
                                Load More (${remainingCount} remaining)
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        function loadMoreVisitors() {
            visibleVisitorCount += 10;
            renderVisitorRows();
        }

        // ========================================
        // EXPORT FUNCTIONALITY
        // ========================================
        document.getElementById('exportSuggestionsBtn').addEventListener('click', async function() {
            try {
                const suggestionsSnapshot = await db.collection('landing_suggestions').orderBy('timestamp', 'desc').get();
                const suggestions = [];

                suggestionsSnapshot.forEach((doc) => {
                    suggestions.push(doc.data());
                });

                if (suggestions.length === 0) {
                    showToast('No suggestions to export', 'warning');
                    return;
                }

                // Create CSV content
                let csv = 'Suggestion,Email,Date,Time\n';
                suggestions.forEach(entry => {
                    const timestamp = entry.timestamp;
                    let date;

                    if (timestamp && timestamp.toDate) {
                        date = timestamp.toDate();
                    } else if (typeof timestamp === 'string') {
                        date = new Date(timestamp);
                    } else {
                        date = new Date();
                    }

                    // Escape quotes in suggestion text
                    const suggestion = (entry.suggestion || '').replace(/"/g, '""');
                    csv += `"${suggestion}",${entry.email || 'Anonymous'},${date.toLocaleDateString()},${date.toLocaleTimeString()}\n`;
                });

                // Download CSV file
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `penny-suggestions-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting data. Please try again.', 'error');
            }
        });

        document.getElementById('exportMessagesBtn').addEventListener('click', async function() {
            try {
                const messagesSnapshot = await db.collection('landing_contact_messages').orderBy('timestamp', 'desc').get();
                const messages = [];

                messagesSnapshot.forEach((doc) => {
                    messages.push(doc.data());
                });

                if (messages.length === 0) {
                    showToast('No contact messages to export', 'warning');
                    return;
                }

                // Create CSV content
                let csv = 'Name,Email,Subject,Message,Date,Time\n';
                messages.forEach(entry => {
                    const timestamp = entry.timestamp;
                    let date;

                    if (timestamp && timestamp.toDate) {
                        date = timestamp.toDate();
                    } else if (typeof timestamp === 'string') {
                        date = new Date(timestamp);
                    } else {
                        date = new Date();
                    }

                    // Escape quotes in text fields
                    const name = (entry.name || '').replace(/"/g, '""');
                    const subject = (entry.subject || '').replace(/"/g, '""');
                    const message = (entry.message || '').replace(/"/g, '""');
                    csv += `"${name}",${entry.email || 'N/A'},"${subject}","${message}",${date.toLocaleDateString()},${date.toLocaleTimeString()}\n`;
                });

                // Download CSV file
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `penny-contact-messages-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting data. Please try again.', 'error');
            }
        });

        document.getElementById('exportBtn').addEventListener('click', async function() {
            try {
                const waitlistSnapshot = await db.collection('landing_waitlist').orderBy('timestamp', 'desc').get();
                const emails = [];

                waitlistSnapshot.forEach((doc) => {
                    emails.push(doc.data());
                });

                if (emails.length === 0) {
                    showToast('No emails to export', 'warning');
                    return;
                }

                // Create CSV content
                let csv = 'Email,Signup Date,Signup Time\n';
                emails.forEach(entry => {
                    const timestamp = entry.timestamp;
                    let date;

                    if (timestamp && timestamp.toDate) {
                        date = timestamp.toDate();
                    } else if (typeof timestamp === 'string') {
                        date = new Date(timestamp);
                    } else {
                        date = new Date();
                    }

                    csv += `${entry.email},${date.toLocaleDateString()},${date.toLocaleTimeString()}\n`;
                });

                // Download CSV file
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `penny-waitlist-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting data. Please try again.', 'error');
            }
        });

        // ========================================
        // ERROR MESSAGES
        // ========================================
        function getErrorMessage(errorCode) {
            const errorMessages = {
                'auth/invalid-email': 'Invalid email address format.',
                'auth/user-disabled': 'This account has been disabled.',
                'auth/user-not-found': 'No account found with this email.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/too-many-requests': 'Too many failed login attempts. Please try again later.',
                'auth/network-request-failed': 'Network error. Please check your connection.',
                'auth/invalid-credential': 'Invalid email or password.'
            };

            return errorMessages[errorCode] || 'An error occurred. Please try again.';
        }

        // Close modals when clicking outside
        document.getElementById('resetPasswordModal').addEventListener('click', function(e) {
            if (e.target === this) {
                document.getElementById('closeResetBtn').click();
            }
        });

        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                document.getElementById('closeSettingsBtn').click();
            }
        });

        // ========================================
        // BLOG MANAGEMENT
        // ========================================
        let currentEditingBlogId = null;

        // Load blog posts
        async function loadBlogPosts() {
            const blogPostsList = document.getElementById('blogPostsList');

            try {
                const blogsSnapshot = await db.collection('landing_blogs').orderBy('createdAt', 'desc').get();

                if (blogsSnapshot.empty) {
                    blogPostsList.innerHTML = '<div class="text-center py-8 text-slate-500">No blog posts yet. Click "New Blog Post" to create one.</div>';
                    return;
                }

                let blogsHTML = '';
                blogsSnapshot.forEach((doc) => {
                    const blog = doc.data();
                    const blogId = doc.id;

                    const createdDate = blog.createdAt && blog.createdAt.toDate
                        ? blog.createdAt.toDate()
                        : new Date();

                    const statusBadge = blog.published
                        ? '<span class="px-3 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded-full">Published</span>'
                        : '<span class="px-3 py-1 bg-amber-100 text-amber-700 text-xs font-semibold rounded-full">Draft</span>';

                    const categoryColors = {
                        'finance': 'bg-blue-100 text-blue-700',
                        'savings': 'bg-green-100 text-green-700',
                        'budgeting': 'bg-purple-100 text-purple-700',
                        'investing': 'bg-indigo-100 text-indigo-700',
                        'news': 'bg-red-100 text-red-700',
                        'tutorials': 'bg-teal-100 text-teal-700',
                        'story': 'bg-pink-100 text-pink-700'
                    };

                    const categoryClass = categoryColors[blog.category] || 'bg-slate-100 text-slate-700';

                    blogsHTML += `
                        <div class="border border-slate-200 rounded-xl p-5 hover:border-penny-300 hover:shadow-md transition-all">
                            <div class="flex justify-between items-start gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h3 class="text-lg font-bold text-slate-900">${escapeHtml(blog.title)}</h3>
                                        ${statusBadge}
                                    </div>
                                    <p class="text-sm text-slate-600 mb-3">${escapeHtml(blog.excerpt)}</p>
                                    <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
                                        <span class="px-2 py-1 ${categoryClass} rounded-full font-medium">${blog.category}</span>
                                        <span>‚Ä¢</span>
                                        <span>By ${escapeHtml(blog.author)}</span>
                                        <span>‚Ä¢</span>
                                        <span>${createdDate.toLocaleDateString()}</span>
                                        <span>‚Ä¢</span>
                                        <span class="font-mono text-xs text-slate-400">/blog/${escapeHtml(blog.slug)}</span>
                                    </div>
                                    ${blog.tags ? `
                                        <div class="flex flex-wrap gap-1 mt-2">
                                            ${blog.tags.split(',').map(tag =>
                                                `<span class="px-2 py-0.5 bg-slate-100 text-slate-600 rounded text-xs">${escapeHtml(tag.trim())}</span>`
                                            ).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                                ${blog.imageUrl ? `
                                    <img src="${escapeHtml(blog.imageUrl)}" alt="Featured" class="w-24 h-24 object-cover rounded-lg">
                                ` : ''}
                            </div>
                            <div class="flex gap-2 mt-4 pt-4 border-t border-slate-100">
                                <button
                                    onclick="editBlogPost('${blogId}')"
                                    class="flex-1 px-4 py-2 bg-penny-50 text-penny-700 font-medium rounded-lg hover:bg-penny-100 transition-colors"
                                >
                                    Edit
                                </button>
                                <button
                                    onclick="toggleBlogPublish('${blogId}', ${!blog.published})"
                                    class="flex-1 px-4 py-2 ${blog.published ? 'bg-amber-50 text-amber-700 hover:bg-amber-100' : 'bg-green-50 text-green-700 hover:bg-green-100'} font-medium rounded-lg transition-colors"
                                >
                                    ${blog.published ? 'Unpublish' : 'Publish'}
                                </button>
                                <button
                                    onclick="deleteBlogPost('${blogId}', '${escapeHtml(blog.title).replace(/'/g, "\\'")}')"
                                    class="px-4 py-2 bg-red-50 text-red-700 font-medium rounded-lg hover:bg-red-100 transition-colors"
                                >
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                });

                blogPostsList.innerHTML = blogsHTML;

            } catch (error) {
                console.error('Error loading blog posts:', error);
                blogPostsList.innerHTML = '<div class="text-center py-8 text-red-500">Error loading blog posts. Please refresh.</div>';
            }
        }

        // Open blog editor modal (create new)
        document.getElementById('createBlogBtn').addEventListener('click', function() {
            currentEditingBlogId = null;
            document.getElementById('blogEditorTitle').textContent = 'Create New Blog Post';
            document.getElementById('blogPostForm').reset();
            document.getElementById('blogPostId').value = '';
            document.getElementById('blogEditorModal').classList.remove('hidden');
        });

        // Close blog editor modal
        document.getElementById('closeBlogEditor').addEventListener('click', function() {
            document.getElementById('blogEditorModal').classList.add('hidden');
            currentEditingBlogId = null;
        });

        document.getElementById('cancelBlogEdit').addEventListener('click', function() {
            document.getElementById('blogEditorModal').classList.add('hidden');
            currentEditingBlogId = null;
        });

        // Auto-generate slug from title
        document.getElementById('blogTitle').addEventListener('input', function() {
            if (!currentEditingBlogId) { // Only auto-generate for new posts
                const title = this.value;
                const slug = title
                    .toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                    .replace(/\s+/g, '-') // Replace spaces with hyphens
                    .replace(/-+/g, '-') // Remove consecutive hyphens
                    .trim();
                document.getElementById('blogSlug').value = slug;
            }
        });

        // Submit blog post form (create or update)
        document.getElementById('blogPostForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                // Check if user is authenticated
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('You must be logged in to create or edit blog posts.');
                }
                console.log('Authenticated user:', currentUser.email);
                const blogData = {
                    title: document.getElementById('blogTitle').value.trim(),
                    slug: document.getElementById('blogSlug').value.trim(),
                    author: document.getElementById('blogAuthor').value.trim(),
                    excerpt: document.getElementById('blogExcerpt').value.trim(),
                    content: document.getElementById('blogContent').value.trim(),
                    category: document.getElementById('blogCategory').value,
                    tags: document.getElementById('blogTags').value.trim(),
                    imageUrl: document.getElementById('blogImageUrl').value.trim(),
                    published: document.getElementById('blogPublished').checked,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (currentEditingBlogId) {
                    // Update existing blog post
                    await db.collection('landing_blogs').doc(currentEditingBlogId).update(blogData);
                    showToast('Blog post updated successfully!', 'success');
                } else {
                    // Create new blog post
                    blogData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('landing_blogs').add(blogData);
                    showToast('Blog post created successfully!', 'success');
                }

                // Close modal and reload
                document.getElementById('blogEditorModal').classList.add('hidden');
                currentEditingBlogId = null;
                await loadBlogPosts();

            } catch (error) {
                console.error('Error saving blog post:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);

                let errorMsg = 'Error saving blog post. ';
                if (error.code === 'permission-denied') {
                    errorMsg += 'Permission denied. Please ensure you are logged in as an admin.';
                } else if (error.code === 'unauthenticated') {
                    errorMsg += 'You are not authenticated. Please log in again.';
                } else {
                    errorMsg += error.message || 'Please try again.';
                }

                showToast(errorMsg, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Edit blog post
        window.editBlogPost = async function(blogId) {
            try {
                const doc = await db.collection('landing_blogs').doc(blogId).get();

                if (!doc.exists) {
                    showToast('Blog post not found.', 'error');
                    return;
                }

                const blog = doc.data();
                currentEditingBlogId = blogId;

                // Populate form
                document.getElementById('blogEditorTitle').textContent = 'Edit Blog Post';
                document.getElementById('blogPostId').value = blogId;
                document.getElementById('blogTitle').value = blog.title || '';
                document.getElementById('blogSlug').value = blog.slug || '';
                document.getElementById('blogAuthor').value = blog.author || '';
                document.getElementById('blogExcerpt').value = blog.excerpt || '';
                document.getElementById('blogContent').value = blog.content || '';
                document.getElementById('blogCategory').value = blog.category || '';
                document.getElementById('blogTags').value = blog.tags || '';
                document.getElementById('blogImageUrl').value = blog.imageUrl || '';
                document.getElementById('blogPublished').checked = blog.published || false;

                // Show modal
                document.getElementById('blogEditorModal').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading blog post:', error);
                showToast('Error loading blog post. Please try again.', 'error');
            }
        };

        // Toggle publish status
        window.toggleBlogPublish = async function(blogId, newPublishState) {
            try {
                await db.collection('landing_blogs').doc(blogId).update({
                    published: newPublishState,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await loadBlogPosts();
                showToast(newPublishState ? 'Blog post published!' : 'Blog post unpublished.', 'success');

            } catch (error) {
                console.error('Error updating publish status:', error);
                showToast('Error updating blog post. Please try again.', 'error');
            }
        };

        // Delete blog post
        window.deleteBlogPost = async function(blogId, blogTitle) {
            if (!confirm(`Are you sure you want to delete "${blogTitle}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                await db.collection('landing_blogs').doc(blogId).delete();
                await loadBlogPosts();
                showToast('Blog post deleted successfully.', 'success');

            } catch (error) {
                console.error('Error deleting blog post:', error);
                showToast('Error deleting blog post. Please try again.', 'error');
            }
        };

        // Close modal when clicking outside
        document.getElementById('blogEditorModal').addEventListener('click', function(e) {
            if (e.target === this) {
                document.getElementById('closeBlogEditor').click();
            }
        });

        // Load blog posts when dashboard loads (add to existing loadDashboardData)
        const originalLoadDashboardData = loadDashboardData;
        loadDashboardData = async function() {
            await originalLoadDashboardData();
            await loadBlogPosts();
        };
    </script>

</body>
</html>
